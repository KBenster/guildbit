{% extends"_layout/base.html" %}

{% block title %}Your Server is Ready!{% endblock %}

{% block body %}
    <div class="content server">
        <div class="title">
            <h1>Your server is ready!</h1>
            <p>Use the details below to connect.</p>
        </div>
        <table class="rounded">
            <thead>
                <tr>
                    <th colspan="2">Mumble Connection Details</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td width="20%">Server</td>
                    <td>{{ server.mumble_host }}</td>
                </tr>
                <tr>
                    <td>Port</td>
                    <td>{{ details.port }}</td>
                </tr>
                <tr>
                    <td>Password</td>
                    <td>{{ server.password }}</td>
                </tr>
                <tr>
                    <td>Direct Link</td>
                    <td><a href="mumble://{{ server.mumble_host }}:{{ details.port }}">mumble://{{ server.mumble_host }}:{{ details.port }}</a></td>
                </tr>
                <tr>
                    <td>
                        <div class="ttip" data-toggle="tooltip" title="Share the connection details easily by copying the snippet to your clipboard">
                            Copy Text
                            <i class="fa fa-question-circle"></i>
                        </div>
                    </td>
                    <td>
                        <div class="copy-url append field">
                            <form class="pure-form">
                                <input id="copy-text" class="pure-u-2-3" type="text" value="Host: {{ server.mumble_host }} Port: {{ details.port }} Pass: {{ server.password }}" readonly="readonly" />
                                <a class="pure-button pure-button-primary" id="copy-button" href="#">Copy</a>
                            </form>
                        </div>
                    </td>
                </tr>
                {% if server.type == 'temp' %}
                <tr>
                    <td>Expires</td>
                    <td><span id="expires-date"></span> (<span id="expires"></span>) </td>
                </tr>
                {% endif %}
                <tr>
                    <td>Slots</td>
                    <td>{{ details.maxusers }}</td>
                </tr>
            </tbody>
        </table>

        <table class="rounded centered" data-bind="with: usersOnline">
            <thead>
                <tr>
                    <th>Users Online (<span data-bind="text: count"></span>)</th>
                    <th class="text-right">Duration</th>
                </tr>
            </thead>
            <tbody>
                <!-- ko foreach: users -->
                <tr>
                    <td data-bind="text: name"></td>
                    <td id="duration" class="text-right" data-bind="text: moment.duration(onlinesecs, 'seconds').humanize()"></td>
                </tr>
                <!-- /ko -->

                <!-- ko if: count == 0 -->
                <tr><td class="text-center" colspan="2">No users are online</td></tr>
                <!-- /ko -->
            </tbody>
        </table>
    </div>

    {% include '_partials/_dont_have_mumble.html' %}

{% endblock %}

{% block scripts %}
    <script src="/static/js/libs/knockout-3.0.0.js"></script>
    <script src="/static/js/libs/moment.min.js"></script>
    <script src="/static/js/libs/ZeroClipboard.min.js"></script>

    <script type="text/javascript">
        // Format expiration date into human friendly
        var base_url = '{{ request.base_url }}'
        var expire_date = '{{ server.expiration }}';
        $("#expires-date").text(moment.utc(expire_date).local().format("ddd, MMM Do, h:mm:ss a"));
        $("#expires").text(moment.utc(expire_date).fromNow());

        //ZeroClipboard for copying mumble server credentials easily
        $(document).ready(function() {
            var client = new ZeroClipboard( document.getElementById("copy-button"), {
              moviePath: "/static/js/libs/ZeroClipboard.swf"
            });
            client.on("load", function(client) {
                client.on("complete", function(client, args) {
                    $(this).text("Copied!");
                });
                client.on('dataRequested', function (client, args) {
                    client.setText($('#copy-text').val());
                });
            });

            //Tooltips
            $('.ttip').tooltip({trigger: 'hover'});
        });

        // Knockout Users Model for displaying and updated users online
        function UsersViewModel() {
            var self = this;

            self.usersOnline = ko.observable(loadUsers());

            // Load initial users into usersOnline observable, then set an interval
            function loadUsers() {
                var users = [];
                $.ajax({
                    url: base_url + "/users",
                    async: false,
                    dataType: "json",
                    success: function (json) {
                        users = json.users;
                    }
                });
                return users;
            }
            setInterval(function() {
                self.usersOnline(loadUsers());
            }, 15000)

        }
        ko.applyBindings(new UsersViewModel());
    </script>
{% endblock %}